<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NASフォルダ検索（フルパス表示＆フォルダオープン対応）</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#475569; --text:#e5e7eb; --accent:#22c55e; --accent2:#38bdf8; }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0b1024,#0e152f);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    .card{background:rgba(17,24,39,.7);backdrop-filter:saturate(140%) blur(6px);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.35)}
    .header{display:flex;gap:14px;align-items:center;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    h1{font-size:20px;margin:0}
    .body{padding:16px 20px}
    label{display:block;font-size:12px;color:#93a4b8;margin:6px 0}
    input[type="text"], input[type="number"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #233047;background:#0b1220;color:var(--text);outline:none}
    input[type="text"]:focus{border-color:#3754f5;box-shadow:0 0 0 3px rgba(56,189,248,.2)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .btn{appearance:none;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,#22c55e,#16a34a);color:#08210f}
    .btn-secondary{background:#0b1220;color:#c7d2fe;border:1px solid #1f2a44}
    .btn-danger{background:#7f1d1d;color:#fff;border:1px solid #b91c1c}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;color:#9fb1c7}
    .switch{display:flex;align-items:center;gap:8px}
    .progress{height:10px;background:#0b1220;border-radius:999px;overflow:hidden;border:1px solid #1f2a44}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#38bdf8,#22c55e)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:12px;color:#9fb1c7;text-align:left;padding:6px 8px}
    .table td{background:#0b1220;border:1px solid #1f2a44;padding:8px;border-left:none;border-right:none}
    .table tr td:first-child{border-radius:10px 0 0 10px;border-left:1px solid #1f2a44}
    .table tr td:last-child{border-radius:0 10px 10px 0;border-right:1px solid #1f2a44}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #1f2a44;background:#0b1220;color:#cbd5e1}
    .highlight{background:rgba(250,204,21,.25);outline:1px solid rgba(250,204,21,.35);border-radius:4px}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;color:#93a4b8;font-size:12px}
    .hidden{display:none}
    .small{font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid #1f2a44;padding:10px 12px;border-radius:10px}
    kbd{background:#111827;border:1px solid #1f2a44;border-bottom-color:#0b1220;border-radius:6px;padding:2px 6px}
    .libwarn{color:#fbbf24}
  </style>
  <!-- ライブラリ（PDF/Office抽出） -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="dot"></div>
        <h1>NAS フォルダ検索 — フルパス表示 & フォルダオープン</h1>
      </div>
      <div class="body">
        <p class="hint">Chrome / Edge 推奨（GitHub Pages でも検索可）。<br>「フォルダを選択」からネットワークドライブや <code>\\192.168.10.101\...</code> を選択してください。<br><span class="libwarn">※ フォルダをOSで直接開く操作は、HTTPS上では制約があるため、必要に応じてパスをクリップボードにコピーしてエクスプローラで開いてください。</span></p>

        <div class="row">
          <div>
            <label>検索フォルダ（表示）</label>
            <input id="folderPath" type="text" placeholder="選択したフォルダ名が表示されます" readonly>
          </div>
          <div>
            <label>ルートパス表示（任意・UNCやドライブ例：\\\\192.168.10.101\\share\\ または Z:\\）</label>
            <input id="rootHint" type="text" placeholder="例：\\\\192.168.10.101\\share\\">
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button class="btn btn-primary" id="pickBtn">フォルダを選択</button>
              <label class="btn btn-secondary" for="folderInput">フォルダ選択（互換モード）</label>
              <input id="folderInput" type="file" webkitdirectory directory multiple class="hidden">
            </div>
            <div class="hint small">Safari/Firefox は互換モードを利用します。</div>
          </div>
          <div>
            <label>検索ワード</label>
            <input id="query" type="text" placeholder="例：議事録 2025 / 見積 *.xlsx / 正規表現: ^請求.*(2024|2025)$">
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div>
            <label>検索設定</label>
            <div class="actions">
              <label class="switch"><input id="fulltext" type="checkbox"> 本文検索（テキスト / PDF / docx / xlsx / pptx）</label>
              <label class="switch"><input id="caseSens" type="checkbox"> 大文字小文字を区別</label>
              <label class="switch"><input id="regex" type="checkbox"> 正規表現</label>
            </div>
            <div class="hint small">PDFはテキスト抽出可能なもののみ。画像PDFはOCR拡張が必要です。</div>
          </div>
          <div>
            <label>除外パターン（;区切り）</label>
            <input id="exclude" type="text" value="$RECYCLE.BIN;~$*;*.tmp;node_modules;@eaDir">
          </div>
        </div>

        <div class="row3" style="margin-top:6px">
          <div>
            <label>本文検索サイズ上限（MB）</label>
            <input id="maxSize" type="number" min="1" step="1" value="20">
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button class="btn btn-primary" id="searchBtn">検索</button>
              <button class="btn btn-danger" id="cancelBtn" disabled>中止</button>
            </div>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button class="btn btn-secondary" id="exportBtn" disabled>結果をCSVで保存</button>
            </div>
          </div>
        </div>

        <div style="margin:14px 0" class="progress"><div class="bar" id="bar"></div></div>
        <div class="footer"><div id="status">未実行</div><div class="hint">ヒント：<kbd>Ctrl</kbd>+<kbd>F</kbd> で結果内検索</div></div>

        <div style="margin-top:16px;overflow:auto">
          <table class="table" id="resultTable">
            <thead>
              <tr>
                <th>ファイル名</th>
                <th>フルパス</th>
                <th>サイズ</th>
                <th>更新日</th>
                <th>一致スニペット</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // ====== 初期化 ======
    if(window['pdfjsLib']){
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.worker.min.js';
    }
    const $$ = (sel, el=document) => el.querySelector(sel);
    const $$$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    const textExt = new Set([".txt",".md",".csv",".log",".json",".html",".htm",".js",".css"]);
    const officeExt = new Set([".pdf",".docx",".xlsx",".pptx"]);

    function extOf(name){ const i=name.lastIndexOf('.'); return i<0?'' : name.slice(i).toLowerCase(); }
    function toMB(b){ return (b/1024/1024).toFixed(2)+" MB"; }
    function fmtDate(ts){ return new Date(ts).toLocaleString(); }
    function wildcardToRegExp(pattern){ const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); return new RegExp('^'+pattern.split('*').map(esc).join('.*')+'$','i'); }
    function parseExclude(raw){ return raw.split(/[;\n]/).map(s=>s.trim()).filter(Boolean).map(wildcardToRegExp); }

    // ルートパス表示（UNC/ドライブ）を保存
    const rootHint = $$('#rootHint');
    rootHint.value = localStorage.getItem('rootHint') || '';
    rootHint.addEventListener('change', ()=> localStorage.setItem('rootHint', rootHint.value));

    function joinFullPath(rootHint, relPath){
      const relWin = relPath.replace(/\//g,'\\');
      if(!rootHint) return relWin; // 擬似フルパス（選択ルート未表示）
      const needsSep = !rootHint.endsWith('\\') && !rootHint.endsWith('/');
      return rootHint + (needsSep?'\\':'') + relWin;
    }

    // ====== PDF/Office 抽出 ======
    async function extractTextFromPDF(arrayBuffer){
      try{ const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise; let out=''; const n=Math.min(pdf.numPages,50); for(let i=1;i<=n;i++){ const page=await pdf.getPage(i); const c=await page.getTextContent(); out += c.items.map(it=>it.str).join(' ')+'\n'; } return out; }catch(e){ console.warn('PDF抽出失敗',e); return ''; }
    }
    async function extractTextFromDocx(buf){ try{ const r=await mammoth.convertToHtml({arrayBuffer:buf}); const tmp=document.createElement('div'); tmp.innerHTML=r.value||''; return tmp.textContent||''; }catch(e){ console.warn('docx抽出失敗',e); return ''; }}
    async function extractTextFromXlsx(buf){ try{ const wb=XLSX.read(buf,{type:'array'}); let out=''; for(const n of wb.SheetNames){ out += XLSX.utils.sheet_to_csv(wb.Sheets[n]) + '\n'; } return out; }catch(e){ console.warn('xlsx抽出失敗',e); return ''; }}
    async function extractTextFromPptx(buf){ try{ const zip=await JSZip.loadAsync(buf); const slideFiles=Object.keys(zip.files).filter(k=>/^ppt\/slides\/slide\d+\.xml$/.test(k)).sort(); let out=''; for(const k of slideFiles){ const xml=await zip.file(k).async('string'); const t=[...xml.matchAll(/<a:t>([\s\S]*?)<\/a:t>/g)].map(m=>m[1].replace(/<[^>]*>/g,'')); out += t.join(' ')+'\n'; } return out; }catch(e){ console.warn('pptx抽出失敗',e); return ''; }}
    async function extractTextByExt(file){ const ext=extOf(file.name); const buf=await file.arrayBuffer(); if(ext==='.pdf') return extractTextFromPDF(buf); if(ext==='.docx') return extractTextFromDocx(buf); if(ext==='.xlsx') return extractTextFromXlsx(buf); if(ext==='.pptx') return extractTextFromPptx(buf); if(textExt.has(ext)){ return new TextDecoder().decode(buf); } return ''; }

    function hitSnippet(text,q,regex,caseSens){ try{ const re = regex? new RegExp(q, caseSens?'g':'gi') : new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), caseSens?'g':'gi'); const m=re.exec(text); if(!m) return null; const s=Math.max(0,m.index-40), e=Math.min(text.length, m.index+m[0].length+60); return (s>0?'…':'') + text.slice(s,e).replace(re, s=>`<span class="highlight">${s}</span>`) + (e<text.length?'…':''); }catch(e){ return null; } }

    function showToast(msg){ const t=$$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none'}, 2200); }

    let dirHandle=null, pickedFiles=[], abortFlag={value:false};
    const folderPath=$$('#folderPath');

    // ディレクトリ選択
    $$('#pickBtn').addEventListener('click', async ()=>{
      if(!window.showDirectoryPicker){ alert('このブラウザはディレクトリ選択APIに未対応です。互換モードをご利用ください。'); return; }
      try{ dirHandle = await showDirectoryPicker({mode:'read'}); pickedFiles=[]; folderPath.value = dirHandle.name || '(選択済み)'; $$('#status').textContent='フォルダ選択済み'; }catch(e){ if(e?.name!=='AbortError') console.error(e); }
    });

    // 互換モード
    $$('#folderInput').addEventListener('change', ()=>{
      pickedFiles = [...$$('#folderInput').files]; dirHandle=null; if(pickedFiles.length){ const root = pickedFiles[0].webkitRelativePath?.split('/')?.[0] ?? '(選択済み)'; folderPath.value = root + '（互換モード）'; $$('#status').textContent = `${pickedFiles.length} 件のファイルを読み込みました`; }
    });

    // ディレクトリ走査（相対パス生成）
    async function* walkDirectory(handle, excludeList, base=''){
      for await(const [name,entry] of handle.entries()){
        if(abortFlag.value) return;
        if(excludeList.some(re=>re.test(name))) continue;
        if(entry.kind==='directory'){
          yield* walkDirectory(entry, excludeList, base + name + '/');
        }else{
          yield {entry, relPath: base + name};
        }
      }
    }

    // フォルダを開く（可能なら file://、不可ならクリップボード）
    async function openFolderOrCopy(fullPath){
      const folder = fullPath.replace(/\\+/g,'\\').replace(/\/+$/,'');
      const lastSep = Math.max(folder.lastIndexOf('\\'), folder.lastIndexOf('/'));
      const dir = lastSep>=0 ? folder.slice(0,lastSep) : folder;
      try{
        if(location.protocol==='file:' || location.hostname==='localhost'){
          const url = 'file:///' + dir.replace(/\\/g,'/');
          window.open(url, '_blank');
        }else{
          await navigator.clipboard.writeText(dir);
          showToast('フォルダパスをコピーしました。エクスプローラのアドレスバーに貼り付けて開いてください。');
        }
      }catch(e){
        console.warn(e);
        await navigator.clipboard.writeText(dir);
        showToast('フォルダパスをコピーしました。アドレスバーに貼り付けて開いてください。');
      }
    }

    function appendRow(r){
      const tr=document.createElement('tr');
      const td=html=>{ const c=document.createElement('td'); c.innerHTML=html; return c; };
      const btnOpen=document.createElement('button'); btnOpen.className='btn btn-secondary'; btnOpen.textContent='フォルダを開く';
      btnOpen.addEventListener('click', ()=> openFolderOrCopy(r.fullPath));

      const btnCopy=document.createElement('button'); btnCopy.className='btn btn-secondary'; btnCopy.style.marginLeft='6px'; btnCopy.textContent='パスコピー';
      btnCopy.addEventListener('click', async()=>{ await navigator.clipboard.writeText(r.fullPath); showToast('フルパスをコピーしました'); });

      tr.appendChild(td(`<span class="badge">${r.name}</span>`));
      tr.appendChild(td(`<span class="small">${r.fullPath}</span>`));
      tr.appendChild(td(`<span class="small">${toMB(r.size)}</span>`));
      tr.appendChild(td(`<span class="small">${r.mtime}</span>`));
      tr.appendChild(td(`<div class="small">${r.snippet||''}</div>`));
      const act = td(''); act.appendChild(btnOpen); act.appendChild(btnCopy); tr.appendChild(act);
      $$('#resultTable tbody').appendChild(tr);
    }

    function downloadCSVFromTable(){
      const rows = $$$('#resultTable tbody tr').map(tr=>{
        const tds = $$$('td', tr);
        return {
          name: tds[0]?.innerText?.trim(),
          fullpath: tds[1]?.innerText?.trim(),
          size: tds[2]?.innerText?.trim(),
          mtime: tds[3]?.innerText?.trim(),
          snippet: tds[4]?.innerText?.trim(),
        }
      });
      const header=['name','fullpath','size','mtime','snippet'];
      const esc=v=>'"'+String(v??'').replace(/"/g,'""')+'"';
      const lines=[header.join(',')].concat(rows.map(r=>[r.name,r.fullpath,r.size,r.mtime,r.snippet].map(esc).join(',')));
      const blob=new Blob(["\ufeff"+lines.join('\n')],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='search_results.csv'; a.click(); URL.revokeObjectURL(a.href);
    }

    // 検索
    async function runSearch(){
      const qRaw=$$('#query').value.trim(); if(!qRaw){ alert('検索ワードを入力してください。'); return; }
      if(!dirHandle && pickedFiles.length===0){ alert('フォルダを選択してください。'); return; }
      const excludeList=parseExclude($$('#exclude').value);
      const isRegex=$$('#regex').checked, isCase=$$('#caseSens').checked, isFull=$$('#fulltext').checked;
      let nameMatcher, contentMatcher; try{ if(isRegex){ nameMatcher=new RegExp(qRaw,isCase?'':'i'); contentMatcher=new RegExp(qRaw,isCase?'g':'gi'); } else { const esc=qRaw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); nameMatcher=new RegExp(esc,isCase?'':'i'); contentMatcher=new RegExp(esc,isCase?'g':'gi'); } }catch(e){ alert('正規表現が不正です: '+e.message); return; }

      const tbody=$$('#resultTable tbody'); tbody.innerHTML=''; $$('#exportBtn').disabled=true; $$('#cancelBtn').disabled=false; $$('#searchBtn').disabled=true; $$('#bar').style.width='0%';
      let processed=0, matched=0, total=pickedFiles.length||0;

      async function handleOne(getFile, relPath){
        const file=await getFile(); processed++; const name=file.name; const size=file.size; const mtime=file.lastModified; const ext=extOf(name);
        let nameHit=nameMatcher.test(name)||nameMatcher.test(relPath||''); let snippet=null;
        if(isFull){ const maxBytes=Number($$('#maxSize').value||20)*1024*1024; if(size<=maxBytes && (officeExt.has(ext)||textExt.has(ext))){ const text=await extractTextByExt(file); if(text && contentMatcher.test(text)){ nameHit=true; snippet=hitSnippet(text,qRaw,isRegex,isCase); } } }
        if(nameHit){ matched++; const fullPath=joinFullPath(rootHint.value, relPath||name); appendRow({name, fullPath, size, mtime: fmtDate(mtime), snippet}); }
        if(total){ $$('#bar').style.width = Math.min(100, Math.floor((processed/total)*100)) + '%'; }
        $$('#status').textContent = `${processed} 件処理 / 一致 ${matched} 件`;
      }

      if(dirHandle){
        let i=0; for await(const item of walkDirectory(dirHandle, excludeList, '')){ if(abortFlag.value) break; await handleOne(async()=>item.entry.getFile(), item.relPath); i++; if(i%20===0) await new Promise(r=>setTimeout(r)); }
      }else{
        total=pickedFiles.length; for(const f of pickedFiles){ if(abortFlag.value) break; await handleOne(async()=>f, f.webkitRelativePath || f.name); }
      }

      $$('#status').textContent = `完了：一致 ${matched} 件`;
      $$('#exportBtn').disabled = $$$('#resultTable tbody tr').length===0;
      $$('#cancelBtn').disabled=false; $$('#searchBtn').disabled=false;
    }

    $$('#searchBtn').addEventListener('click', runSearch);
    $$('#cancelBtn').addEventListener('click', ()=>{ abortFlag.value=true; $$('#status').textContent='中止しました'; $$('#searchBtn').disabled=false; });
    $$('#exportBtn').addEventListener('click', downloadCSVFromTable);
    $$('#query').addEventListener('keydown', e=>{ if(e.key==='Enter'){ runSearch(); }});
  </script>
</body>
</html>
