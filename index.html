<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NASフォルダ検索（フルパス表示・フォルダオープン版）</title>
  <style>
    body{font-family:system-ui, sans-serif;background:#0b1024;color:#e5e7eb;margin:0;padding:20px}
    input,button{font:inherit}
    .btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:#22c55e;color:#000}
    .btn-secondary{background:#334155;color:#fff}
    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border:1px solid #334155;padding:6px;font-size:13px}
    .highlight{background:rgba(250,204,21,.25)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <h1>NASフォルダ検索（フルパス表示・フォルダオープン版）</h1>
  <div>
    <button id="pickBtn" class="btn btn-primary">フォルダを選択</button>
    <label><input type="checkbox" id="fulltext"> 本文検索（PDF/Office対応）</label>
    <input id="query" type="text" placeholder="検索ワード">
    <button id="searchBtn" class="btn btn-secondary">検索</button>
  </div>
  <p id="status"></p>
  <table id="resultTable"><thead><tr><th>ファイル名</th><th>フルパス</th><th>一致スニペット</th><th>操作</th></tr></thead><tbody></tbody></table>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.worker.min.js';
  const $$ = sel => document.querySelector(sel);
  const textExt = new Set([".txt",".md",".csv",".log",".json"]);
  const officeExt = new Set([".pdf",".docx",".xlsx",".pptx"]);

  let dirHandle = null;
  async function extractText(file){
    const ext=file.name.split('.').pop().toLowerCase();
    const buf=await file.arrayBuffer();
    try{
      if(ext==='pdf'){const pdf=await pdfjsLib.getDocument({data:buf}).promise;let out='';for(let i=1;i<=Math.min(pdf.numPages,30);i++){const page=await pdf.getPage(i);const c=await page.getTextContent();out+=c.items.map(it=>it.str).join(' ');}return out;}
      if(ext==='docx'){const r=await mammoth.convertToHtml({arrayBuffer:buf});const tmp=document.createElement('div');tmp.innerHTML=r.value;return tmp.textContent;}
      if(ext==='xlsx'){const wb=XLSX.read(buf,{type:'array'});let out='';wb.SheetNames.forEach(n=>{out+=XLSX.utils.sheet_to_csv(wb.Sheets[n])});return out;}
      if(ext==='pptx'){const zip=await JSZip.loadAsync(buf);let out='';for(const f of Object.keys(zip.files))if(f.match(/^ppt\/slides\/slide\d+\.xml$/)){const xml=await zip.file(f).async('string');const t=[...xml.matchAll(/<a:t>([\s\S]*?)<\/a:t>/g)].map(m=>m[1]);out+=t.join(' ');}return out;}
      if(textExt.has('.'+ext)){return new TextDecoder().decode(buf);}
    }catch(e){console.warn('抽出失敗',e);}
    return '';
  }

  async function* walkDirectory(handle){
    for await(const [name,entry] of handle.entries()){
      if(entry.kind==='directory'){yield* walkDirectory(entry);} else yield entry;
    }
  }

  function highlight(text,q){const r=new RegExp(q,'i');const m=text.match(r);if(!m)return '';const i=m.index;return '…'+text.slice(Math.max(0,i-30),i)+'<span class="highlight">'+m[0]+'</span>'+text.slice(i+m[0].length,i+m[0].length+30)+'…';}

  $$('#pickBtn').onclick=async()=>{dirHandle=await showDirectoryPicker();$$('#status').textContent='選択: '+dirHandle.name;}

  $$('#searchBtn').onclick=async()=>{
    if(!dirHandle)return alert('フォルダを選択');
    const q=$$('#query').value.trim();if(!q)return alert('検索ワード入力');
    const tbody=$$('#resultTable tbody');tbody.innerHTML='';
    let count=0;
    for await(const entry of walkDirectory(dirHandle)){
      const file=await entry.getFile();const path=entry.name;const ext=file.name.split('.').pop().toLowerCase();
      let matched=file.name.toLowerCase().includes(q.toLowerCase());let snippet='';
      if(!matched&&$$('#fulltext').checked&&(textExt.has('.'+ext)||officeExt.has('.'+ext))){
        const text=await extractText(file);
        if(text.toLowerCase().includes(q.toLowerCase())){matched=true;snippet=highlight(text,q);}
      }
      if(matched){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${file.name}</td><td>${entry.fullPath||entry.name}</td><td>${snippet}</td>`;
        const tdOp=document.createElement('td');
        const btn=document.createElement('button');btn.textContent='フォルダを開く';btn.className='btn btn-secondary';
        btn.onclick=()=>{window.open('file://'+(entry.fullPath||entry.name).replace(/\\/g,'/').replace(/^([A-Za-z]):/,'/$1:'),'_blank');};
        tdOp.appendChild(btn);tr.appendChild(tdOp);tbody.appendChild(tr);count++;}
    }
    $$('#status').textContent=`検索完了 (${count} 件)`;
  }
</script>
</body>
</html>
